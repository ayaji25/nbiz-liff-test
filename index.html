<script>
  const LIFF_ID = "2007008877-RekeNxWY";

  async function ensureScopes() {
    const scopes = await liff.getGrantedScopes();
    const need = ["chat_message.write","openid","profile"];
    const missing = need.some(s => !scopes.includes(s));
    if (missing) {
      try { liff.logout(); } catch(e) {}
      liff.login({ scope: need });
      return false; // ここで遷移するので以降は実行されない
    }
    return true;
  }

  async function init() {
    const status = document.getElementById('status');
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login({ scope:["chat_message.write","openid","profile"] }); return; }

      // 権限チェック（未付与なら再ログインへ）
      const ok = await ensureScopes();
      if (!ok) return;

      document.getElementById('sendBtn').addEventListener('click', async () => {
        status.textContent = "送信中…";
        try {
          await liff.sendMessages([{ type: "text", text: "ほげほげ面談希望" }]);
          status.innerHTML = '<span class="ok">送信しました ✅</span>';
        } catch (e) {
          status.innerHTML = '<span class="err">送信エラー：' + String(e) + '</span>';
        }
      });
    } catch (e) {
      status.innerHTML = '<span class="err">LIFF初期化エラー：' + String(e) + '</span>';
    }
  }
  init();
</script>
